---
title: "Clock In & Out Analysis"
author: "Tino Muzambi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(plotly)
```

# Read in data
```{r}
# Read data
data <- read_csv("data/data.csv", col_types = "cccc") %>% as_tibble()
```

```{r}
# View data
data
```

# Prepare data for analysis
```{r}
# Rename columns using dplyr
data <- data %>% rename(
  date = Date,
  clock.in = "Clock In Time",
  clock.out = "Clock Out Time",
  notes = Notes
)

data
```

```{r}
# Add id column
data <- data %>% 
  mutate(id = rownames(data))

data
```

```{r}
# Cast date, clock.in and clock.out using lubridate and dplyr
data <- data %>% 
  mutate(date = lubridate::parse_date_time(date, orders = "dmy"),
         clock.in = parse_date_time(clock.in, orders = "%H:%M"),
         clock.out = parse_date_time(clock.out, orders = "%H:%M"),
         notes = gsub(" ", "_", notes),
         notes = gsub(":", "_", notes),
         notes = gsub("-", "_", notes))

data
```

```{r}
# Separate options from notes into separate columns
data.tidy <- data %>% separate_rows(notes, sep = ",_")

data.tidy
```

```{r}
# List out note options
# notes.options <- unique(data.tidy$notes)[-1]
# notes.options <- c("Work_from_home", "Post_Work_Commitment",
#                    "Pre_Work_Commitment", "16_00_lecture", "14_00_lecture",
#                    "Public_Holiday", "Annual_leave", "11_00_lecture",
#                    "Study_leave", "Conference", "Sick_leave")

# notes.options
```

```{r}
# data.tidy <- data.tidy %>% 
#   mutate(across(all_of(notes.options), ~
#                   if_else(notes == ., TRUE, FALSE),
#                 .names = "{.col}"))

# data.tidy
```

```{r}
# Create indicator columns for note options
data.tidy <- data.tidy %>% 
  mutate(note_Work_from_home = if_else(notes == "Work_from_home", TRUE, FALSE),
         note_Post_Work_Commitment = if_else(notes == "Post_Work_Commitment", TRUE, FALSE),
         note_Pre_Work_Commitment = if_else(notes == "Pre_Work_Commitment", TRUE, FALSE),
         note_16_00_lecture = if_else(notes == "16_00_lecture", TRUE, FALSE),
         note_14_00_lecture = if_else(notes == "14_00_lecture", TRUE, FALSE),
         note_11_00_lecture = if_else(notes == "11_00_lecture", TRUE, FALSE),
         note_Annual_leave = if_else(notes == "Annual_leave", TRUE, FALSE),
         note_Sick_leave = if_else(notes == "Sick_leave", TRUE, FALSE),
         note_Study_leave = if_else(notes == "Study_leave", TRUE, FALSE),
         note_Public_Holiday = if_else(notes == "Public_Holiday", TRUE, FALSE),
         note_Conference = if_else(notes == "Conference", TRUE, FALSE))

data.tidy
```

```{r}
# Group by ID and summarise
data.collapsed <- data.tidy %>% 
  group_by(id) %>% 
  summarise(
    note_Work_from_home = max(note_Work_from_home),
    note_Post_Work_Commitment = max(note_Post_Work_Commitment),
    note_Pre_Work_Commitment = max(note_Pre_Work_Commitment),
    note_16_00_lecture = max(note_16_00_lecture),
    note_14_00_lecture = max(note_14_00_lecture),
    note_11_00_lecture = max(note_11_00_lecture),
    note_Annual_leave = max(note_Annual_leave),
    note_Sick_leave = max(note_Sick_leave),
    note_Study_leave = max(note_Study_leave),
    note_Public_Holiday = max(note_Public_Holiday),
    note_Conference = max(note_Conference),
    .groups = "drop"
  )

data.collapsed
```

```{r}
# Combine dataframes
data.combined <- full_join(data.collapsed, data)

data.combined
```

```{r}
# Replace NAs with 0s in indicator columns.
data.combined <- data.combined %>% 
  mutate(across(starts_with("note_"), ~
                  replace(., is.na(.), 0))) %>% 
  mutate(notes = replace(notes, is.na(notes), "Standard"))

data.combined
```

```{r}
# Pivot wider
# data.wide <- data.tidy %>%
#   pivot_wider(id_cols = id,
#               names_from = notes,
#               values_from = starts_with("note_"))
```

# Compile summaries of data
```{r}
# Pivot longer
data.long <- data.combined %>%
  gather(key = "event.type",
         value = "time", clock.in, clock.out) %>% 
  mutate(event.type = ifelse(event.type == "clock.in", 
                             "Clock In", "Clock Out"),
         notes = str_split(notes, ",_")) %>% 
  unnest(notes)
```

```{r}
time.summaries <- data.long %>% group_by(notes, event.type) %>% 
  summarise(
    n = n(),
    mean.time = format(mean(time, na.rm = T), "%H:%M"),
  )

time.summaries
```

```{r}
# Days where I had a 16:00 lecture vs not
data.combined %>% group_by(note_16_00_lecture) %>%
  summarise(
  n = n(),
  mean.clock.in = mean(clock.in, na.rm = T),
  mean.clock.out = mean(clock.out, na.rm = T)
)
```

```{r}
# Overall mean times
# Calculate mean times
mean.clock.in <- mean(data$clock.in, na.rm = T)
mean.clock.out <- mean(data$clock.out, na.rm = T)

# Mean time spent at office
mean.office.time <- mean.clock.out - mean.clock.in
mean.office.time
```

# Plot some graphs
```{r}
ggplot(data.combined,
       aes(x = date)) +
  geom_line(aes(y = clock.in, color = "Clock In"), linewidth = 1) +
  geom_line(aes(y = clock.out, color = "Clock Out"), linewidth = 1) +
  scale_color_manual(values = c("Clock In" = "blue", "Clock Out" = "red")) +
  labs(title = "Clock in and Clock Out Times for 2024",
       x = "Date",
       y = "Time",
       color = "Legend") +
  theme_minimal() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
```

```{r}
ggplot(data.combined,
       aes(x = date)) +
  geom_point(aes(y = clock.in, color = "Clock In")) +
  geom_point(aes(y = clock.out, color = "Clock Out")) +
  scale_color_manual(values = c("Clock In" = "blue", "Clock Out" = "red")) +
  labs(title = "Clock in and Clock Out Times for 2024",
       x = "Date",
       y = "Time",
       color = "Legend") +
  theme_minimal() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
```

```{r}
# Plot more detailed plot
clock.in.out.detail <- ggplot(data.long, aes(x = date, y = time, colour = notes, fill = notes, shape = event.type)) +
  geom_jitter(size = 3, width = 1, height = 1, alpha = 0.7) +
  scale_color_manual(values = c("Post_Work_Commitment" = "green",
                   "Pre_Work_Commitment" = "grey", "16_00_lecture" = "blue", "14_00_lecture" = "red", "11_00_lecture" = "black",
                   "Study_leave" = "yellow", "Conference" = "purple","Standard" = "orange"),
                   labels = c("Work_from_home" = "Work from home", "Post_Work_Commitment" = "Post-work commitment",
                   "Pre_Work_Commitment" = "Post-work commitment", "16_00_lecture" = "16:00 lecture", "14_00_lecture" = "14:00 lecture",
                   "Public_Holiday" = "Public holiday", "Annual_leave" = "Annual leave", "11_00_lecture" = "11:00 lecture",
                   "Study_leave" = "Study leave", "Conference" = "Conference", "Sick_leave" = "Sick leave", "Standard" = "Standard")) + 
  scale_fill_manual(values = c("Post_Work_Commitment" = "green",
                   "Pre_Work_Commitment" = "grey", "16_00_lecture" = "blue", "14_00_lecture" = "red", "11_00_lecture" = "black",
                   "Study_leave" = "yellow", "Conference" = "purple","Standard" = "orange"),
                   labels = c("Work_from_home" = "Work from home", "Post_Work_Commitment" = "Post-work commitment",
                   "Pre_Work_Commitment" = "Post-work commitment", "16_00_lecture" = "16:00 lecture", "14_00_lecture" = "14:00 lecture",
                   "Public_Holiday" = "Public holiday", "Annual_leave" = "Annual leave", "11_00_lecture" = "11:00 lecture",
                   "Study_leave" = "Study leave", "Conference" = "Conference", "Sick_leave" = "Sick leave", "Standard" = "Standard")) +
  scale_shape_manual(values = c("Clock In" = 24, "Clock Out" = 25)) +
  labs(title = "Clock in and Clock Out Times for 2024",
       x = "Date",
       y = "Time",
       color = "Event",
       fill = "Event",
       shape = "Event Type") +
  theme_minimal() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
# ggplotly(clock.in.out.detail)
clock.in.out.detail
```

```{r}
# Add mean times to plot
clock.in.out.detail + 
  geom_hline(yintercept = mean.clock.in, color = "blue", linetype = "dashed") + 
  geom_hline(yintercept = mean.clock.out, color = "red", linetype = "dashed") +
  geom_text(aes(x = as.POSIXct("2024-01-01"), y = mean.clock.in, label = paste(format(mean.clock.in, "%H:%M"))), color = "blue", vjust = -0.5, hjust = 1.2) + 
  geom_text(aes(x = as.POSIXct("2024-01-01"), y = mean.clock.out, label = paste(format(mean.clock.out, "%H:%M"))), color = "red", vjust = -0.5, hjust = 1.2) 
```

