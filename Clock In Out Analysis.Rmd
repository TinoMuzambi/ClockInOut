---
title: "Clock In & Out Analysis"
author: "Tino Muzambi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
```

# Read in data
```{r}
# Read data
data <- read_csv("data/data.csv", col_types = "cccc") %>% as_tibble()
```

```{r}
# View data
data
```

# Prepare data for analysis
```{r}
# Rename columns using dplyr
data <- data %>% rename(
  date = Date,
  clock.in = "Clock In Time",
  clock.out = "Clock Out Time",
  notes = Notes
)

data
```

```{r}
# Add id column
data <- data %>% 
  mutate(id = rownames(data))

data
```

```{r}
# Cast date, clock.in and clock.out using lubridate and dplyr
data <- data %>% 
  mutate(date = lubridate::parse_date_time(date, orders = "dmy"),
         clock.in = parse_date_time(clock.in, orders = "%H:%M"),
         clock.out = parse_date_time(clock.out, orders = "%H:%M"),
         notes = gsub(" ", "_", notes),
         notes = gsub(":", "_", notes),
         notes = gsub("-", "_", notes))

data
```

```{r}
# Separate options from notes into separate columns
data.tidy <- data %>% separate_rows(notes, sep = ",_")

data.tidy
```

```{r}
# List out note options
# notes.options <- unique(data.tidy$notes)[-1]
# notes.options <- c("Work_from_home", "Post_Work_Commitment",
#                    "Pre_Work_Commitment", "16_00_lecture", "14_00_lecture",
#                    "Public_Holiday", "Annual_leave", "11_00_lecture",
#                    "Study_leave", "Conference", "Sick_leave")

# notes.options
```

```{r}
# data.tidy <- data.tidy %>% 
#   mutate(across(all_of(notes.options), ~
#                   if_else(notes == ., TRUE, FALSE),
#                 .names = "{.col}"))

# data.tidy
```

```{r}
# Create indicator columns for note options
data.tidy <- data.tidy %>% 
  mutate(note_Work_from_home = if_else(notes == "Work_from_home", TRUE, FALSE),
         note_Post_Work_Commitment = if_else(notes == "Post_Work_Commitment", TRUE, FALSE),
         note_Pre_Work_Commitment = if_else(notes == "Pre_Work_Commitment", TRUE, FALSE),
         note_16_00_lecture = if_else(notes == "16_00_lecture", TRUE, FALSE),
         note_14_00_lecture = if_else(notes == "14_00_lecture", TRUE, FALSE),
         note_11_00_lecture = if_else(notes == "11_00_lecture", TRUE, FALSE),
         note_Annual_leave = if_else(notes == "Annual_leave", TRUE, FALSE),
         note_Sick_leave = if_else(notes == "Sick_leave", TRUE, FALSE),
         note_Study_leave = if_else(notes == "Study_leave", TRUE, FALSE),
         note_Public_Holiday = if_else(notes == "Public_Holiday", TRUE, FALSE),
         note_Conference = if_else(notes == "Conference", TRUE, FALSE))

data.tidy
```

```{r}
# Group by ID and summarise
data.collapsed <- data.tidy %>% 
  group_by(id) %>% 
  summarise(
    note_Work_from_home = max(note_Work_from_home),
    note_Post_Work_Commitment = max(note_Post_Work_Commitment),
    note_Pre_Work_Commitment = max(note_Pre_Work_Commitment),
    note_16_00_lecture = max(note_16_00_lecture),
    note_14_00_lecture = max(note_14_00_lecture),
    note_11_00_lecture = max(note_11_00_lecture),
    note_Annual_leave = max(note_Annual_leave),
    note_Sick_leave = max(note_Sick_leave),
    note_Study_leave = max(note_Study_leave),
    note_Public_Holiday = max(note_Public_Holiday),
    note_Conference = max(note_Conference),
    .groups = "drop"
  )

data.collapsed
```

```{r}
# Combine dataframes
data.combined <- full_join(data.collapsed, data)

data.combined
```

```{r}
# Replace NAs with 0s in indicator columns.
data.combined <- data.combined %>% 
  mutate(across(starts_with("note_"), ~
                  replace(., is.na(.), 0)))

data.combined
```

```{r}
# Pivot wider
# data.wide <- data.tidy %>%
#   pivot_wider(id_cols = id,
#               names_from = notes,
#               values_from = starts_with("note_"))
```

# View summaries of data
```{r}
# Days where I had a 16:00 lecture vs not
data.combined %>% group_by(note_16_00_lecture) %>%
  summarise(
  n = n(),
  mean.clock.in = mean(clock.in, na.rm = T),
  mean.clock.out = mean(clock.out, na.rm = T)
)
```

```{r}
# Days where I had a 14:00 lecture vs not
data.combined %>% group_by(note_14_00_lecture) %>%
  summarise(
    n = n(),
    mean.clock.in = mean(clock.in, na.rm = T),
    mean.clock.out = mean(clock.out, na.rm = T)
  )
```

```{r}
# Days where I had a 11:00 lecture vs not
data.combined %>% group_by(note_11_00_lecture) %>%
  summarise(
    n = n(),
    mean.clock.in = mean(clock.in, na.rm = T),
    mean.clock.out = mean(clock.out, na.rm = T)
  )
```

```{r}
# Days where I had a post-work commitment vs not
data.combined %>% group_by(note_Post_Work_Commitment) %>%
  summarise(
    n = n(),
    mean.clock.in = mean(clock.in, na.rm = T),
    mean.clock.out = mean(clock.out, na.rm = T)
  )
```

```{r}
# Days where I had a pre-work commitment vs not
data.combined %>% group_by(note_Pre_Work_Commitment) %>%
  summarise(
    n = n(),
    mean.clock.in = mean(clock.in, na.rm = T),
    mean.clock.out = mean(clock.out, na.rm = T)
  )
```

# Plot some graphs
```{r}
ggplot(data.combined,
       aes(x = date)) +
  geom_line(aes(y = clock.in, color = "Clock In"), linewidth = 1) +
  geom_line(aes(y = clock.out, color = "Clock Out"), linewidth = 1) +
  scale_color_manual(values = c("Clock In" = "blue", "Clock Out" = "red")) +
  labs(title = "Clock in and Clock Out Times for 2024",
       x = "Date",
       y = "Time",
       color = "Legend") +
  theme_minimal() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
```

```{r}
ggplot(data.combined,
       aes(x = date)) +
  geom_point(aes(y = clock.in, color = "Clock In")) +
  geom_point(aes(y = clock.out, color = "Clock Out")) +
  scale_color_manual(values = c("Clock In" = "blue", "Clock Out" = "red")) +
  labs(title = "Clock in and Clock Out Times for 2024",
       x = "Date",
       y = "Time",
       color = "Legend") +
  theme_minimal() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
```

```{r}
# Pivot longer for more detailed plot
data.long <- data.combined %>%
  gather(key = "event.type",
         value = "time", clock.in, clock.out) %>% 
  mutate(event.type = ifelse(event.type == "clock.in", 
                             "Clock In", "Clock Out"),
         notes = str_split(notes, ", ")) %>% 
  unnest(notes)
```

